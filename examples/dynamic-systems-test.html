<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPC Dynamic Systems Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
        }
        h2 {
            color: #555;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #45a049;
        }
        .status-box {
            background: #f9f9f9;
            padding: 15px;
            border-left: 4px solid #4CAF50;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .need {
            display: inline-block;
            width: 45%;
            margin: 5px;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 4px;
        }
        .thought {
            padding: 8px;
            margin: 5px 0;
            background: #fff3e0;
            border-left: 3px solid #ff9800;
        }
        .positive { border-left-color: #4caf50; background: #e8f5e9; }
        .negative { border-left-color: #f44336; background: #ffebee; }
    </style>
</head>
<body>
    <h1>NPC Dynamic Systems Test Suite</h1>

    <div class="section">
        <h2>System Initialization</h2>
        <button onclick="initializeSystems()">Initialize Systems</button>
        <div id="init-status" class="status-box"></div>
    </div>

    <div class="section">
        <h2>Test NPC</h2>
        <button onclick="createTestNPC()">Create Test NPC</button>
        <button onclick="showNPCStatus()">Show NPC Status</button>
        <div id="npc-info" class="status-box"></div>
    </div>

    <div class="section">
        <h2>Time Progression</h2>
        <button onclick="advanceTime(1)">+1 Hour</button>
        <button onclick="advanceTime(8)">+8 Hours</button>
        <button onclick="advanceTime(24)">+24 Hours</button>
        <div id="time-info" class="status-box"></div>
    </div>

    <div class="section">
        <h2>Social Interactions</h2>
        <button onclick="testInteraction('small-talk', true)">Small Talk (Success)</button>
        <button onclick="testInteraction('compliment', true)">Compliment (Success)</button>
        <button onclick="testInteraction('deep-conversation', true)">Deep Talk (Success)</button>
        <button onclick="testInteraction('insult', true)">Insult (Success)</button>
        <div id="interaction-info" class="status-box"></div>
    </div>

    <div class="section">
        <h2>Satisfy Needs</h2>
        <button onclick="satisfyNeed('sustenance', 50)">Feed NPC</button>
        <button onclick="satisfyNeed('rest', 80)">Let NPC Sleep</button>
        <button onclick="satisfyNeed('social', 35)">Socialize</button>
        <div id="needs-info" class="status-box"></div>
    </div>

    <div class="section">
        <h2>Add Thoughts</h2>
        <button onclick="addThought('had-good-conversation')">Good Conversation</button>
        <button onclick="addThought('saw-corpse')">Saw Corpse</button>
        <button onclick="addThought('saved-by-hero')">Life Saved</button>
        <button onclick="addThought('betrayed')">Betrayed</button>
        <div id="thoughts-info" class="status-box"></div>
    </div>

    <script src="../scripts/social/npc-needs-system.js"></script>
    <script src="../scripts/social/npc-thoughts-system.js"></script>
    <script src="../scripts/social/npc-mood-calculator.js"></script>
    <script src="../scripts/social/npc-relationship-dynamics.js"></script>
    <script src="../scripts/social/npc-behavior-engine.js"></script>
    <script src="../scripts/social/npc-time-manager.js"></script>
    <script src="../scripts/social/npc-dynamic-systems.js"></script>

    <script>
        let testNPC = null;
        let systems = null;
        let playerCharacter = {
            id: 'player-1',
            name: 'Player Character'
        };

        async function initializeSystems() {
            const status = document.getElementById('init-status');
            status.textContent = 'Initializing...';

            try {
                systems = new NPCDynamicSystems();
                const success = await systems.initialize();

                if (success) {
                    status.textContent = '✓ All systems initialized successfully!\n\n' +
                        'Systems ready:\n' +
                        '- Needs System\n' +
                        '- Thoughts System\n' +
                        '- Mood Calculator\n' +
                        '- Relationship Dynamics\n' +
                        '- Behavior Engine\n' +
                        '- Time Manager';
                } else {
                    status.textContent = '✗ Initialization failed. Check console for errors.';
                }
            } catch (error) {
                status.textContent = '✗ Error: ' + error.message;
                console.error(error);
            }
        }

        function createTestNPC() {
            if (!systems || !systems.initialized) {
                alert('Please initialize systems first!');
                return;
            }

            // Create a test NPC
            testNPC = {
                id: 'npc-test-1',
                name: 'Thorin Stonefist',
                ancestry: 'dwarf',
                personalities: ['pompous', 'greedy', 'brave'],
                motivation: 'gain-wealth',
                occupation: 'merchant'
            };

            // Initialize dynamic systems
            systems.initializeNPC(testNPC);

            document.getElementById('npc-info').textContent =
                'Created: ' + testNPC.name + '\n' +
                'Ancestry: ' + testNPC.ancestry + '\n' +
                'Personalities: ' + testNPC.personalities.join(', ') + '\n\n' +
                'Dynamic systems initialized!';

            showNPCStatus();
        }

        function showNPCStatus() {
            if (!testNPC) {
                alert('Please create a test NPC first!');
                return;
            }

            const status = systems.getStatus(testNPC);

            let output = '=== NPC STATUS ===\n\n';

            // Mood
            output += `Mood: ${status.mood.current.name} (Score: ${status.mood.score}/100)\n`;
            output += `Attitude: ${status.mood.current.attitude}\n`;
            output += `Social DC: ${status.mood.current.socialDC}\n\n`;

            // Needs
            output += '=== NEEDS ===\n';
            for (const need of status.needs.needs) {
                output += `${need.icon} ${need.name}: ${need.current}/${need.max} `;
                output += `(${need.threshold?.label || 'OK'})\n`;
            }
            output += `\nOverall: ${status.needs.overall} (${Math.round(status.needs.overallScore)}%)\n`;
            if (status.needs.warnings.length > 0) {
                output += `⚠️ Warnings: ${status.needs.warnings.join(', ')}\n`;
            }
            output += '\n';

            // Thoughts
            output += `=== THOUGHTS (${status.thoughts.total}) ===\n`;
            if (status.thoughts.positive.length > 0) {
                output += 'Positive:\n';
                for (const thought of status.thoughts.positive) {
                    output += `  ${thought.icon} ${thought.name} (+${thought.currentMoodEffect})\n`;
                }
            }
            if (status.thoughts.negative.length > 0) {
                output += 'Negative:\n';
                for (const thought of status.thoughts.negative) {
                    output += `  ${thought.icon} ${thought.name} (${thought.currentMoodEffect})\n`;
                }
            }
            output += `\nTotal mood effect: ${status.thoughts.moodEffect >= 0 ? '+' : ''}${status.thoughts.moodEffect}\n\n`;

            // Relationships
            output += `=== RELATIONSHIPS (${status.relationships.total}) ===\n`;
            output += `Friends: ${status.relationships.friends}\n`;
            output += `Enemies: ${status.relationships.enemies}\n`;
            output += `Romantic: ${status.relationships.romantic}\n\n`;

            if (status.relationships.relationships.length > 0) {
                output += 'Details:\n';
                for (const rel of status.relationships.relationships.slice(0, 5)) {
                    output += `  ${rel.npcName}: ${rel.opinion} (${rel.relationshipType})\n`;
                }
            }

            output += '\n';

            // Behavior
            output += `=== BEHAVIOR ===\n`;
            output += `Current: ${status.behavior.currentBehavior || 'idle'}\n`;
            output += `Priority: ${status.behavior.priority}\n`;
            output += `Description: ${status.behavior.description}\n`;

            document.getElementById('npc-info').textContent = output;
        }

        function advanceTime(hours) {
            if (!testNPC) {
                alert('Please create a test NPC first!');
                return;
            }

            const result = systems.advanceTime(hours, [testNPC]);

            let output = `Advanced time by ${hours} hours\n\n`;
            output += `Updated: ${result.updated} NPCs\n`;
            output += `Thoughts expired: ${result.thoughtsExpired}\n`;
            output += `Relationships decayed: ${result.relationshipsDecayed}\n\n`;

            if (result.criticalNeeds.length > 0) {
                output += '⚠️ CRITICAL NEEDS:\n';
                for (const cn of result.criticalNeeds) {
                    output += `  ${cn.npcName}: ${cn.needs.join(', ')}\n`;
                }
                output += '\n';
            }

            if (result.moodChanges.length > 0) {
                output += 'MOOD CHANGES:\n';
                for (const mc of result.moodChanges) {
                    output += `  ${mc.npcName}: ${mc.oldMood} → ${mc.newMood}\n`;
                }
            }

            document.getElementById('time-info').textContent = output;
            showNPCStatus();
        }

        function testInteraction(interactionId, success) {
            if (!testNPC) {
                alert('Please create a test NPC first!');
                return;
            }

            const result = systems.processSocialInteraction(
                playerCharacter,
                testNPC,
                interactionId,
                { skill: 'diplomacy', dc: 15, passed: success }
            );

            let output = `Interaction: ${result.interactionName}\n`;
            output += `Success: ${result.success ? 'Yes' : 'No'} (${Math.round(result.successChance * 100)}% chance)\n\n`;
            output += `Message: ${result.message}\n\n`;

            if (result.relationship) {
                output += `Opinion change: ${result.relationship.opinionChange >= 0 ? '+' : ''}${result.relationship.opinionChange}\n`;
                output += `New opinion: ${result.relationship.opinion}\n`;
                output += `Relationship: ${result.relationship.relationshipType}\n`;
                output += `Trust: ${result.relationship.trustLevel}\n`;
            }

            document.getElementById('interaction-info').textContent = output;
            showNPCStatus();
        }

        function satisfyNeed(needId, amount) {
            if (!testNPC) {
                alert('Please create a test NPC first!');
                return;
            }

            const result = systems.satisfyNeed(testNPC, needId, amount);

            let output = `Satisfied: ${needId}\n`;
            output += `Amount: +${result.amountSatisfied}\n`;
            output += `Before: ${result.oldValue} (${result.oldThreshold?.label})\n`;
            output += `After: ${result.newValue} (${result.newThreshold?.label})\n`;

            if (result.thresholdChanged) {
                output += `\n✓ Threshold changed!\n`;
            }

            document.getElementById('needs-info').textContent = output;
            showNPCStatus();
        }

        function addThought(thoughtId) {
            if (!testNPC) {
                alert('Please create a test NPC first!');
                return;
            }

            const result = systems.addThought(testNPC, thoughtId, {
                name: playerCharacter.name
            });

            let output = '';
            if (result.success) {
                output = `Added thought: ${result.thought.name}\n`;
                output += `Description: ${result.thought.description}\n`;
                output += `Mood effect: ${result.moodEffect >= 0 ? '+' : ''}${result.moodEffect}\n`;
                output += `Duration: ${result.thought.duration === Infinity ? 'Permanent' : (result.thought.duration / 3600000) + ' hours'}\n`;
            } else {
                output = `Failed: ${result.message}`;
            }

            document.getElementById('thoughts-info').textContent = output;
            showNPCStatus();
        }

        // Auto-initialize on load
        window.addEventListener('load', () => {
            setTimeout(initializeSystems, 500);
        });
    </script>
</body>
</html>
